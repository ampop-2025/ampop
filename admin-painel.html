<style>
  table {
    width: 100%;
    border-collapse: collapse;
  }

  th, td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: left;
  }

  .inactive {
    color: #aaa;
  }

  .highlight-date {
    background-color: #e6f0ff;
  }

  thead {
    background-color: #f4f4f4;
  }

  .action-btn {
    margin-right: 5px;
  }
</style>

<input type="text" id="searchInput" placeholder="Buscar por e-mail ou status..." oninput="filtrarEmails()">

<table>
  <thead>
    <tr>
      <th onclick="ordenarEmails('email')">E-mail</th>
      <th onclick="ordenarEmails('status')">Status</th>
      <th onclick="ordenarEmails('created')">Criado em</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="emailTable"></tbody>
</table>

<script type="module">
  import { db } from "./firebase-config.js";
  import {
    collection, getDocs, setDoc, doc, deleteDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-lite.js";

  const emailTable = document.getElementById("emailTable");
  const searchInput = document.getElementById("searchInput");
  let listaEmails = [];
  let ordemAtual = { campo: "", crescente: true };

  async function carregarEmails() {
    const querySnapshot = await getDocs(collection(db, "autorizados"));
    listaEmails = [];
    querySnapshot.forEach((docSnap) => {
      const dados = docSnap.data();
      listaEmails.push({
        email: docSnap.id,
        status: dados.status || "ativo",
        created: dados.created?.toDate ? dados.created.toDate() : null
      });
    });
    exibirEmails(listaEmails);
  }

  function exibirEmails(lista) {
    emailTable.innerHTML = "";
    lista.forEach(user => {
      const dataFormatada = user.created
        ? user.created.toLocaleDateString("pt-BR") + " " + user.created.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' })
        : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td contenteditable="true" data-email="${user.email}">${user.email}</td>
        <td>${user.status}</td>
        <td class="highlight-date">${dataFormatada}</td>
        <td>
          <button class="action-btn" onclick="alterarStatus('${user.email}', '${user.status}')">Alterar Status</button>
          <button class="action-btn" onclick="editarEmail('${user.email}', this)">Salvar Edição</button>
          <button class="action-btn" onclick="excluirEmail('${user.email}')">Excluir</button>
        </td>
      `;
      if (user.status === "inativo") tr.classList.add("inactive");
      emailTable.appendChild(tr);
    });
  }

  function filtrarEmails() {
    const termo = searchInput.value.toLowerCase();
    const filtrados = listaEmails.filter(u =>
      u.email.toLowerCase().includes(termo) ||
      u.status.toLowerCase().includes(termo)
    );
    exibirEmails(filtrados);
  }

  function ordenarEmails(campo) {
    const crescente = ordemAtual.campo === campo ? !ordemAtual.crescente : true;
    ordemAtual = { campo, crescente };
    listaEmails.sort((a, b) => {
      const valA = a[campo] ?? "";
      const valB = b[campo] ?? "";
      if (campo === "created") {
        return crescente
          ? (valA?.getTime?.() || 0) - (valB?.getTime?.() || 0)
          : (valB?.getTime?.() || 0) - (valA?.getTime?.() || 0);
      }
      return crescente
        ? valA.toString().localeCompare(valB.toString())
        : valB.toString().localeCompare(valA.toString());
    });
    exibirEmails(listaEmails);
  }

  window.alterarStatus = async (email, status) => {
    const novoStatus = status === "ativo" ? "inativo" : "ativo";
    await updateDoc(doc(db, "autorizados", email), { status: novoStatus });
    carregarEmails();
  };

  window.editarEmail = async (antigoEmail, botao) => {
    const td = botao.closest("tr").children[0];
    const novoEmail = td.innerText.trim();
    if (!novoEmail || novoEmail === antigoEmail) return;
    const docAntigo = doc(db, "autorizados", antigoEmail);
    const dadosAntigos = (await getDocs(collection(db, "autorizados"))).docs.find(d => d.id === antigoEmail)?.data();
    if (!dadosAntigos) return;
    await setDoc(doc(db, "autorizados", novoEmail), { ...dadosAntigos });
    await deleteDoc(docAntigo);
    carregarEmails();
  };

  window.excluirEmail = async (email) => {
    if (confirm(`Tem certeza que deseja excluir o e-mail ${email}?`)) {
      await deleteDoc(doc(db, "autorizados", email));
      carregarEmails();
    }
  };

  carregarEmails();
</script>
